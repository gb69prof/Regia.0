<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Regia – lezioni vive su LIM</title>

<style>
:root{ --bg:#111; --panel:#1e1e1e; --accent:#4da3ff; --text:#f2f2f2; }
*{ box-sizing:border-box; }

html, body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
}

/* Layout: dvh + fill-available per iOS Safari */
#app{
  display:grid;
  grid-template-columns:280px 1fr;
  height:100dvh;
  min-height:-webkit-fill-available;
}

/* Sidebar */
#scenes{
  background:var(--panel);
  padding:10px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.scene{
  padding:12px;
  margin-bottom:8px;
  background:#2a2a2a;
  border-radius:10px;
  cursor:pointer;
  user-select:none;
}
.scene.active{ outline:2px solid var(--accent); }

/* Main */
#main{
  position:relative;
  min-width:0;
  height:100%;
  overflow:hidden;
}

/* Toolbar FIXED */
#toolbar{
  position:fixed;
  left:280px;
  right:0;
  top:0;
  z-index:1000;
  display:flex;
  gap:8px;
  padding:10px;
  background:#000;
  flex-wrap:wrap;
}

/* Editor sotto la toolbar */
#editor{
  position:absolute;
  top:68px;
  left:0;
  right:0;
  bottom:0;
  padding:16px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

button{
  padding:12px 14px;
  font-size:16px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#000;
}
button.secondary{ background:#333; color:var(--text); }
button:active{ transform:scale(0.98); }

input, textarea{
  width:100%;
  margin-bottom:10px;
  padding:12px;
  font-size:18px;
  border-radius:10px;
  border:none;
}
textarea{ min-height:140px; }

/* =======================
   PROJECTION (overlay vero)
   ======================= */
#projection{
  position:fixed;
  inset:0;
  background:#000;
  color:#fff;
  display:none;
  padding:28px 28px 22px;
  overflow:hidden;
  touch-action:pan-y;
  z-index:5000; /* sopra toolbar */
}

#pTitle{ margin:0 0 14px; font-size:44px; line-height:1.1; }
#pText{ margin:0 0 16px; font-size:26px; line-height:1.35; white-space:pre-wrap; }

#pAsset{
  width:100%;
  height: calc(100% - 170px);
  position:relative;
  overflow:hidden;
}

/* Zoom/pan immagini */
#zoomStage{
  width:100%;
  height:100%;
  position:absolute;
  inset:0;
  overflow:hidden;
  border-radius:12px;
  background:#000;
  display:none;
  touch-action:none;
}

#zoomImg{
  position:absolute;
  left:50%;
  top:50%;
  transform-origin:center center;
  will-change: transform;
  user-select:none;
  -webkit-user-drag:none;
}

/* fallback (video/audio/pdf) */
#pAssetFallback{
  position:absolute;
  inset:0;
  display:none; /* IMPORTANTISSIMO: non deve stare affiancato allo zoomStage */
  align-items:center;
  justify-content:center;
}

#pAssetFallback video,
#pAssetFallback iframe{
  width:100%;
  height:100%;
  border:0;
  border-radius:12px;
}
#pAssetFallback audio{
  width:min(900px, 95%);
}

/* Controls */
#pControls{
  position:absolute;
  top:12px;
  right:12px;
  display:flex;
  gap:10px;
  z-index:20;
}
#pNav{
  position:absolute;
  bottom:12px;
  left:12px;
  right:12px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  z-index:20;
}
.pBtn{
  padding:12px 14px;
  font-size:18px;
  border:none;
  border-radius:12px;
  background:rgba(255,255,255,0.16);
  color:#fff;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}
.pBtn:active{ transform:scale(0.98); }
.pBtn.primary{ background:rgba(77,163,255,0.95); color:#000; }
.pBtn.wide{ flex:1; }

/* Zoom controls */
#zoomControls{
  position:absolute;
  left:12px;
  top:12px;
  display:none;
  gap:10px;
  z-index:20;
}
#zoomControls .pBtn{ min-width:56px; text-align:center; }

/* Black overlay */
#black{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:9999;
}

/* responsive sidebar */
@media (max-width: 820px){
  #app{ grid-template-columns:220px 1fr; }
  #toolbar{ left:220px; }
}
@media (max-width: 600px){
  #editor{ top:110px; }
}
</style>
</head>

<body>

<div id="app">
  <div id="scenes"></div>

  <div id="main">
    <div id="toolbar">
      <button onclick="addScene()">+ Scena</button>
      <button class="secondary" onclick="deleteScene()">Elimina scena</button>
      <button class="secondary" onclick="startProjection()">Proiezione</button>
      <button class="secondary" onclick="exportProject()">Esporta</button>
      <button class="secondary" onclick="importProject()">Importa</button>
    </div>

    <div id="editor">
      <input id="title" placeholder="Titolo scena">
      <textarea id="text" placeholder="Testo / punti chiave"></textarea>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
        <input type="file" id="file" accept="image/*,video/*,audio/*,application/pdf" style="flex:1; min-width:260px;">
        <button class="secondary" onclick="clearAsset()">Rimuovi asset</button>
      </div>

      <div id="asset" style="opacity:0.85;"></div>

      <div style="opacity:0.75; font-size:14px; margin-top:10px; line-height:1.3;">
        Nota: le <b>immagini</b> vengono salvate nel progetto e tornano dopo Import.
        Video/Audio/PDF locali sono temporanei: per conservarli usa URL.
      </div>
    </div>
  </div>
</div>

<!-- Projection -->
<div id="projection">
  <div id="pControls">
    <button class="pBtn" onclick="toggleBlack()">Schermo nero</button>
    <button class="pBtn primary" id="fsBtn" onclick="toggleFullscreen()">Schermo intero</button>
    <button class="pBtn" onclick="stopProjection()">Esci</button>
  </div>

  <div id="zoomControls">
    <button class="pBtn" onclick="zoomStep(1.15)">+</button>
    <button class="pBtn" onclick="zoomStep(1/1.15)">−</button>
    <button class="pBtn" onclick="resetZoom()">Reset</button>
  </div>

  <h1 id="pTitle"></h1>
  <p id="pText"></p>

  <div id="pAsset">
    <div id="zoomStage">
      <img id="zoomImg" alt="immagine">
    </div>
    <div id="pAssetFallback"></div>
  </div>

  <div id="pNav">
    <button class="pBtn wide" onclick="prevScene()">◀ Indietro</button>
    <button class="pBtn wide" onclick="nextScene()">Avanti ▶</button>
  </div>
</div>

<div id="black"></div>

<script>
/* MODEL */
let scenes = [];
let current = -1;

const $ = (id) => document.getElementById(id);
const scenesBox = $("scenes");
const projection = $("projection");
const black = $("black");
const fsBtn = $("fsBtn");

const zoomStage = $("zoomStage");
const zoomImg = $("zoomImg");
const zoomControls = $("zoomControls");
const fallback = $("pAssetFallback");

/* Swipe */
let swipeStartX = null, swipeStartT = 0;

/* =========================
   ZOOM ENGINE (centro vero + fit)
   ========================= */
let baseScale = 1;  // vista iniziale (fit)
let scale = 1;
let offsetX = 0;
let offsetY = 0;

function applyTransform(){
  zoomImg.style.transform =
    `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
}

function fitAndCenter(){
  const stage = zoomStage.getBoundingClientRect();
  const iw = zoomImg.naturalWidth;
  const ih = zoomImg.naturalHeight;
  if(!iw || !ih) return;

  baseScale = Math.min(stage.width / iw, stage.height / ih);
  baseScale = Math.min(1.2, baseScale); // evita pixeloni su immagini piccole

  scale = baseScale;
  offsetX = 0;
  offsetY = 0;
  applyTransform();
}

function resetZoom(){
  scale = baseScale;
  offsetX = 0;
  offsetY = 0;
  applyTransform();
}

function zoomStep(f){
  scale = Math.min(8, Math.max(baseScale, scale * f));
  applyTransform();
}

/* Gesture: drag + pinch */
let mode = null;
let start = null;

zoomStage.addEventListener("touchstart", e => {
  e.preventDefault();

  if(e.touches.length === 1){
    mode = "drag";
    start = {
      x: e.touches[0].clientX,
      y: e.touches[0].clientY,
      ox: offsetX,
      oy: offsetY
    };
  } else if(e.touches.length === 2){
    mode = "pinch";
    const dx = e.touches[1].clientX - e.touches[0].clientX;
    const dy = e.touches[1].clientY - e.touches[0].clientY;
    start = {
      d: Math.hypot(dx, dy),
      s: scale
    };
  }
},{ passive:false });

zoomStage.addEventListener("touchmove", e => {
  e.preventDefault();

  if(mode === "drag" && e.touches.length === 1){
    offsetX = start.ox + (e.touches[0].clientX - start.x);
    offsetY = start.oy + (e.touches[0].clientY - start.y);
    applyTransform();
  } else if(mode === "pinch" && e.touches.length === 2){
    const dx = e.touches[1].clientX - e.touches[0].clientX;
    const dy = e.touches[1].clientY - e.touches[0].clientY;
    const d = Math.hypot(dx, dy);
    scale = Math.min(8, Math.max(baseScale, start.s * (d / start.d)));
    applyTransform();
  }
},{ passive:false });

zoomStage.addEventListener("touchend", () => {
  mode = null;
  start = null;
},{ passive:false });

/* =========================
   SCENES UI
   ========================= */
function addScene(){
  scenes.push({ title:"Nuova scena", text:"", asset:null, type:null, assetName:null, assetIsEmbedded:false });
  selectScene(scenes.length - 1);
  renderScenes();
}

function deleteScene(){
  if (current < 0) return;
  scenes.splice(current, 1);
  if (scenes.length === 0) {
    scenes.push({ title:"Nuova scena", text:"", asset:null, type:null, assetName:null, assetIsEmbedded:false });
    current = 0;
  } else {
    current = Math.min(current, scenes.length - 1);
  }
  renderScenes();
  renderEditor();
}

function selectScene(i){
  current = i;
  renderScenes();
  renderEditor();
}

function renderScenes(){
  scenesBox.innerHTML = "";
  scenes.forEach((s, i) => {
    const d = document.createElement("div");
    d.className = "scene" + (i === current ? " active" : "");
    d.textContent = s.title || ("Scena " + (i+1));
    d.onclick = () => selectScene(i);
    scenesBox.appendChild(d);
  });
}

function renderEditor(){
  if(current < 0) return;
  const s = scenes[current];
  $("title").value = s.title || "";
  $("text").value = s.text || "";
  if (s.asset) {
    const kind = (s.type || "").startsWith("image/") ? "Immagine" : "Asset";
    const note = s.assetIsEmbedded ? " (salvata nel progetto)" : " (temporaneo)";
    $("asset").textContent = `${kind}: ${s.assetName || "file"}${note}`;
  } else {
    $("asset").textContent = "";
  }
}

$("title").addEventListener("input", () => {
  if(current < 0) return;
  scenes[current].title = $("title").value;
  renderScenes();
});
$("text").addEventListener("input", () => {
  if(current < 0) return;
  scenes[current].text = $("text").value;
});

/* =========================
   FILE INPUT (immagini embedded)
   ========================= */
$("file").addEventListener("change", (e) => {
  if(current < 0) return;
  const f = e.target.files[0];
  if(!f) return;

  const type = f.type || "";
  scenes[current].type = type;
  scenes[current].assetName = f.name || "file";

  if (type.startsWith("image/")) {
    const r = new FileReader();
    r.onload = () => {
      scenes[current].asset = r.result;       // data:image/...;base64,...
      scenes[current].assetIsEmbedded = true;
      renderEditor();
    };
    r.readAsDataURL(f);
    return;
  }

  scenes[current].asset = URL.createObjectURL(f); // temporaneo
  scenes[current].assetIsEmbedded = false;
  renderEditor();
});

function clearAsset(){
  if(current < 0) return;
  scenes[current].asset = null;
  scenes[current].type = null;
  scenes[current].assetName = null;
  scenes[current].assetIsEmbedded = false;
  $("file").value = "";
  renderEditor();
}

/* =========================
   PROJECTION (fix “due finestre”)
   ========================= */
function startProjection(){
  if(current < 0) return;
  showProjection();
}

function stopProjection(){
  projection.style.display = "none";
  if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
}

function showImageMode(){
  zoomStage.style.display = "block";
  zoomControls.style.display = "flex";
  fallback.style.display = "none";
  fallback.innerHTML = "";
}

function showFallbackMode(){
  zoomStage.style.display = "none";
  zoomControls.style.display = "none";
  fallback.style.display = "flex";
  fallback.innerHTML = "";
}

function showProjection(){
  const s = scenes[current];
  projection.style.display = "block";
  $("pTitle").textContent = s.title || "";
  $("pText").textContent = s.text || "";

  if (!s.asset) {
    showFallbackMode();
    return;
  }

  const t = s.type || "";
  const a = (typeof s.asset === "string") ? s.asset : "";

  if (t.startsWith("image/") || a.startsWith("data:image/")) {
    showImageMode();

    zoomImg.onload = () => fitAndCenter();
    zoomImg.src = s.asset;

  } else if (t.startsWith("video/")) {
    showFallbackMode();
    const v = document.createElement("video");
    v.src = s.asset;
    v.controls = true;
    v.playsInline = true;
    fallback.appendChild(v);

  } else if (t.startsWith("audio/")) {
    showFallbackMode();
    const aEl = document.createElement("audio");
    aEl.src = s.asset;
    aEl.controls = true;
    fallback.appendChild(aEl);

  } else if (t === "application/pdf") {
    showFallbackMode();
    const iframe = document.createElement("iframe");
    iframe.src = s.asset;
    fallback.appendChild(iframe);

  } else {
    showFallbackMode();
    const d = document.createElement("div");
    d.textContent = "Asset non supportato in anteprima.";
    fallback.appendChild(d);
  }
}

function prevScene(){
  if(current > 0){
    current--;
    showProjection();
    renderScenes();
  }
}
function nextScene(){
  if(current < scenes.length - 1){
    current++;
    showProjection();
    renderScenes();
  }
}

/* Swipe (non dentro zoomStage) */
projection.addEventListener("touchstart", (e) => {
  if (e.target && (e.target.id === "zoomStage" || e.target.id === "zoomImg")) return;
  if(e.touches.length !== 1) return;
  swipeStartX = e.touches[0].clientX;
  swipeStartT = Date.now();
}, { passive:true });

projection.addEventListener("touchend", (e) => {
  if(swipeStartX === null) return;
  const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : swipeStartX;
  const dx = endX - swipeStartX;
  const dt = Date.now() - swipeStartT;
  if(Math.abs(dx) > 70 && dt < 700){
    if(dx > 0) prevScene();
    else nextScene();
  }
  swipeStartX = null;
}, { passive:true });

/* Black screen */
function toggleBlack(){
  black.style.display = (black.style.display === "block") ? "none" : "block";
}
black.addEventListener("click", () => black.style.display = "none");

/* Fullscreen */
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement){
      await projection.requestFullscreen();
      fsBtn.textContent = "Esci schermo intero";
    } else {
      await document.exitFullscreen();
      fsBtn.textContent = "Schermo intero";
    }
    // rifit dopo cambio viewport, se c'è un'immagine
    setTimeout(() => {
      if (projection.style.display === "block" && zoomStage.style.display === "block") fitAndCenter();
    }, 140);
  } catch(err){
    fsBtn.textContent = "Fullscreen non disponibile";
    setTimeout(()=> fsBtn.textContent = "Schermo intero", 1200);
  }
}
document.addEventListener("fullscreenchange", () => {
  fsBtn.textContent = document.fullscreenElement ? "Esci schermo intero" : "Schermo intero";
});

/* Resize/orientamento: rifit immagine */
window.addEventListener("resize", () => {
  if (projection.style.display === "block" && zoomStage.style.display === "block") {
    setTimeout(fitAndCenter, 140);
  }
});

/* =========================
   EXPORT / IMPORT
   ========================= */
function exportProject(){
  const safe = scenes.map(s => {
    const a = (typeof s.asset === "string") ? s.asset : null;
    const assetToSave =
      (a && (a.startsWith("data:image/") || a.startsWith("http://") || a.startsWith("https://")))
        ? a
        : null;

    return {
      title: s.title || "",
      text: s.text || "",
      type: s.type || null,
      assetName: s.assetName || null,
      assetIsEmbedded: !!(assetToSave && assetToSave.startsWith("data:image/")),
      asset: assetToSave
    };
  });

  const blob = new Blob([JSON.stringify(safe, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "regia.json";
  a.click();
}

function importProject(){
  const i = document.createElement("input");
  i.type = "file";
  i.accept = "application/json";
  i.onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        scenes = (Array.isArray(data) ? data : []).map(s => ({
          title: s.title || "Scena",
          text: s.text || "",
          asset: s.asset || null,
          type: s.type || (typeof s.asset === "string" && s.asset.startsWith("data:image/") ? "image/*" : null),
          assetName: s.assetName || null,
          assetIsEmbedded: !!s.assetIsEmbedded || (typeof s.asset === "string" && s.asset.startsWith("data:image/"))
        }));
        if(scenes.length === 0){
          scenes.push({ title:"Nuova scena", text:"", asset:null, type:null, assetName:null, assetIsEmbedded:false });
        }
        selectScene(0);
      } catch(err){
        alert("JSON non valido.");
      }
    };
    r.readAsText(f);
  };
  i.click();
}

/* Init */
addScene();
</script>

</body>
</html>
